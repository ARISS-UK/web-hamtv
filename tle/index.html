<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="ISS TLE Viewer">
<meta name="author" content="ARISS Principia & British Amateur Television Club">
<meta name="keywords" content="">
<link rel="icon" href="/favicon.ico">
<title>ARISS TLE</title>
<link href="/lib/bootstrap-4.0.0/css/bootstrap.min.css" rel="stylesheet">
<link href="/lib/ariss.css" rel="stylesheet">
<style>
body {
    margin: 0;
    padding: 0;
    line-height: 2em;
}
.page-row {
  padding-bottom: 10px;
    color: #FFFFFF;
    font-family: "Open Sans", Arial, sans-serif;
    font-weight: bold;
}
#footer {
  padding-top: 14px;
  padding-left: 8%;
  padding-bottom: 14px;
  font-family: "Open Sans", Arial, sans-serif;
  font-size: 14px;
  font-weight: 500;
  background-color: #111B23;
  color: #666;
}
table {
	width: 60%;
}
td {
	width: 70px;
}
#textarea-tle {
    margin-top: 10px;
    margin-bottom: 10px;
    padding-left: 5px;
    width: 650px;
    height: 120px;
    color: #000;
}
</style>
</head>
<body>
<img id="header-image" src="/images/ariss-stream-logo.png"></img>

<div class="navbar navbar-light navbar-expand-lg" role="navigation">
  <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
    <span class="navbar-toggler-icon"></span>
  </button>
    <div class="navbar-collapse collapse">
      <div class="navbar-nav">
        <a href="/" class="nav-item nav-link">Event Webcast</a>
        <a href="#" class="nav-item nav-link active">Latest TLE</a>
        <a href="/hamtv/" class="nav-item nav-link">HAMTV Receivers</a>
        <a href="/goonhilly/" class="nav-item nav-link" target="_blank">Goonhilly Dashboard</a>
        <a href="https://principia.ariss.org/" class="nav-item nav-link" target="_blank">ARISS Principia</a>
      </div>
    </div>
</div>

<div id="page-background">
<div class="container">
<div class="row page-row">
  <div class="col-md-12">
    <h1>Latest Space-Track ISS TLE</h1>
    <textarea readonly id="textarea-tle"></textarea>
    <table>
    <tr>
      <td>TLE Updated:&nbsp;</td><td id="iss-data-fileupdated"></td>
    </tr>
    <tr>
      <td>TLE Epoch:&nbsp;</td><td id="iss-data-epoch"></td>
    </tr>
    <tr>
      <td>Raw Link:&nbsp;</td><td><a href="http://ariss.batc.tv/iss.txt" target="_blank">http://ariss.batc.tv/iss.txt</a></td>
    </tr>
    <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
    <tr><td colspan="2"><h4><b>Calculated Goonhilly Data</b></h4></td></tr>
    <tr>
      <td width="150px">Time to Goonhilly <span id="iss-data-nextaos-name">AOS: </span></td>
      <td><span id="iss-data-nextaos"></span></td>
    </tr>
    <tr>
      <td>Goonhilly Elevation:&nbsp;</td>
      <td id="iss-data-elevation"></td>
    </tr>
    <tr>
      <td>Goonhilly Range:&nbsp;</td>
      <td id="iss-data-range"></td>
    </tr>
  </table>
  </div>
</div>
</div>
</div>
<div id="footer">
© ARISS UK & BATC
</div>
</div>
</body>
<script src="/lib/jquery-3.3.1.min.js"></script>
<script src="/lib/bootstrap-4.0.0/js/bootstrap.min.js"></script>
<script src="/lib/orbits-1.2.1.js"></script>
<script>
/*** Phil's Satellite Code ***/
var iss;
var future_iss;
var ourLocation = [50.049, -5.183]; // Goonhilly by default
var ourAltitude = 0; // Meters
var aosThreshold = 0; // Degrees
var tleDate = "";
var epochDate = "";

page_run();
setInterval(page_run,10*1000);
setInterval(function() {
    if (typeof iss !== 'undefined') {
        iss.refresh();
        updateISSData();
    }
}, 1000);

/* Data update function */
function updateISSData()
{
    //document.getElementById("iss-data-altitude").textContent = Math.round(iss.orbit.getAltitude()*10)/10 + " km";
    $("#iss-data-range").text(Math.round((latlonRange(ourLocation,ourAltitude,iss.orbit.getPosition(),iss.orbit.getAltitude()*1000))/100)/10 + " km");
    var issElevation = relativeElevation(ourLocation,ourAltitude,iss.orbit.getPosition(),iss.orbit.getAltitude()*1000);
    $("#iss-data-elevation").text(Math.round(issElevation*10)/10 + "°");
    if(issElevation>aosThreshold)
    {
        /* We're in a pass */
        $("#iss-data-nextaos-name").text("LOS: ");
        var los = findLos(ourLocation,ourAltitude,aosThreshold);
        if(los !== null)
        {
            $("#iss-data-nextaos").text(aosTimeString(los));
        }
    }
    else
    {
        /* We're waiting for the next pass */
        $("#iss-data-nextaos-name").text("AOS: ");
        var aos = findAos(ourLocation,ourAltitude,aosThreshold);
        if(aos !== null)
        {
            $("#iss-data-nextaos").text(aosTimeString(aos));
        }
    }
}
function page_run()
{
	$.ajax({
	    url:      "https://ariss.batc.tv/iss.txt",
	    type:     'GET',
	    cache:      false,
	    success: function(data, status, xhr)
	    {
		var stations = orbits.util.parseTLE(data);
		var i = 0;
		for(;i < stations.length; i++)
		{
		    if(stations[i].name == "ISS (ZARYA)") {
			var satOpts = {
			    tle: stations[i],
			    pathLength: 1,
			  };
			 
			iss = new orbits.Satellite(satOpts);  
			future_iss = new orbits.Satellite(satOpts);  
			iss.refresh();

			$("#textarea-tle").val(stations[i].text.trim());
			
			tleDate = convertDateToUTC(new Date(xhr.getResponseHeader("Last-Modified")));
			$("#iss-data-fileupdated").text(tleDate.toLocaleDateString() + " " + tleDate.toLocaleTimeString() + " UTC");

			epochDate = convertDateToUTC(epochToDate(iss.tle.epoch_year,iss.tle.epoch_day));
			$("#iss-data-epoch").text(epochDate.toLocaleDateString() + " " + epochDate.toLocaleTimeString() + " UTC");
			
                        updateISSData();
		    }
		}
	    },
	    error: function()
	    {
		console.log("TLE Error.");
	    }
	});
}
/* Hours, minutes, seconds string construction function */
function aosTimeString(aosTime) {
    var now = new Date();
    var d = new Date(now.getTime());
    var diff = aosTime.getTime() - d.getTime();
    var diff_as_date = new Date(diff);
    return pad(diff_as_date.getUTCHours(),2) + ":" + pad(diff_as_date.getUTCMinutes(),2) + ":" + pad(diff_as_date.getUTCSeconds(),2);
}
function pad(num, size) {
    var s = num+"";
    while (s.length < size) s = "0" + s;
    return s;
}
function epochToDate(year, fday){
  var date = new Date(year, 0); // initialize a date in `year-01-01`
  
  var day = Math.floor(fday);
  date = new Date(date.setDate(day));
  
  var hours = Math.floor((fday - day)*24);
  date = new Date(date.setHours(hours));
  
  var minutes = Math.floor(((fday-day)-(hours/24))*(24*60));
  return new Date(date.setMinutes(minutes)); // add the number of days
}
function convertDateToUTC(date) {
  return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds());
}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-76514704-4', 'auto');
ga('send', 'pageview');
var gaTimer = setInterval(function() { ga('send', 'event', 'realtime', 'tle-page-1m'); }, 60*1000);
setTimeout(function() { window.location.href=window.location.href; }, 6*60*60*1000);
</script>
</html>
